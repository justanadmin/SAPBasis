#!/bin/bash

check_parameters() {
  local parameter_file=$1
  local system_id=$2
  local changes_file=$3
  local log_file=$4

  echo "Starting parameter checks..." >> "$log_file"
  
  # Remove existing changes file
  rm -f "$changes_file"
  echo "Existing changes file removed." >> "$log_file"

  # Get current date and time for logging
  start_time=$(date "+%Y-%m-%d %H:%M:%S")
  echo "Start time: $start_time" >> "$log_file"

  echo "Reading parameter file: $parameter_file" >> "$log_file"

  # Create a header for the changes table
  echo -e "Parameter Name\tRecommended Value\tCurrent Value\tStatus" >> "$changes_file"

  # Read the parameter file line by line
  while IFS= read -r line || [ -n "$line" ]; do
    # Skip empty lines or lines starting with a comment character #
    if [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]]; then
      continue
    fi

    # Split the line into tagName, recommendedValue, and parameterType
    read -r tagName recommendedValue parameterType <<<"$line"

    echo "Checking parameter: $tagName..." >> "$log_file"

    # Retrieve the current value based on parameterType
    case $parameterType in
      DBM | dbm)
        current_value=$(db2 get dbm cfg | awk -F'=' -v tag="$tagName" '/$tagName/ { gsub(/[[:space:]]+/, "", $2); print $2 }' | head -n 1)
        ;;
      SID | sid)
        current_value=$(db2 get db cfg for $system_id | awk -F'=' -v tag="$tagName" '/$tagName/ { gsub(/[[:space:]]+/, "", $2); print $2 }' | head -n 1)
        ;;
      *)
        echo "Invalid parameter type: $parameterType. Skipping..." >> "$log_file"
        continue
        ;;
    esac

    # Compare the current value with the recommended value
    if [ "$current_value" != "$recommendedValue" ]; then
      echo -e "$tagName\t$recommendedValue\t$current_value\tNOT OK" >> "$changes_file"
      echo "Change recommended: $recommendedValue" >> "$log_file"
      echo "Change recorded in $changes_file." >> "$log_file"
    else
      echo -e "$tagName\t$recommendedValue\t$current_value\tOK" >> "$changes_file"
      echo "No changes required." >> "$log_file"
    fi

  done < "$parameter_file"

  # Get end time and calculate script execution duration
  end_time=$(date "+%Y-%m-%d %H:%M:%S")
  echo "End time: $end_time" >> "$log_file"
  echo "Script execution duration: $(($(date -d "$end_time" +%s) - $(date -d "$start_time" +%s))) seconds" >> "$log_file"

  echo "All parameter checks completed. Please check the $changes_file file for any required changes." >> "$log_file"

  echo "Parameter checks completed." >> "$log_file"
}

# Call the check_parameters() function
check_parameters "$1" "$2" "$3" "$4"
